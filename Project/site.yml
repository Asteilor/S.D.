- name: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
  hosts: web
  become: yes
  roles:
    - web

- name: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ PostgreSQL master
  hosts: db-master
  become: true
  roles:
    - role: db
      tags: ['master']
  vars:
    pg_role: master
    pg_version: "14"
    pg_data_dir: "/var/lib/postgresql/14/main"
    pg_listen_address: "0.0.0.0"
    rep_user: "replica"
    rep_pass: "replica_pass"
    rep_hosts: "192.168.56.12"
    pg_admin_pass: "admin_pass"

- name: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ PostgreSQL slave
  hosts: db-slave
  become: true
  roles:
    - role: db
      tags: ['slave']
  vars:
    pg_role: slave
    pg_version: "14"
    pg_data_dir: "/var/lib/postgresql/14/main"
    pg_master_host: "192.168.56.11"
    rep_user: "replica"
    rep_pass: "replica_pass"
    pg_admin_pass: "admin_pass"

- name: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Prometheus
  hosts: monitor
  roles:
    - role: monitoring/prometheus

- name: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ node_exporter
  hosts: all
  become: yes
  roles:
    - role: exporters/node_exporter
      tags: node_exporter

- name: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ postgres_exporter
  hosts: db-master:db-slave
  roles:
    - role: exporters/postgres_exporter

- name: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Grafana
  hosts: monitor
  become: yes
  roles:
    - role: monitoring/grafana
      tags: grafana

- name: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Grafana (–¥–∞—Ç–∞ —Å–æ—Ä—Å –∏ –¥–∞—à–±–æ—Ä–¥—ã)
  hosts: monitor
  become: yes
  roles:
    - role: monitoring/grafana_config
      tags: grafana_config

- name: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Alertmanager
  hosts: monitor
  become: yes
  roles:
    - role: monitoring/alertmanager
      tags: alertmanager

- name: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ rsyslog-—Å–µ—Ä–≤–µ—Ä–∞ (—Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ)
  hosts: monitor
  become: yes
  roles:
    - role: logging/rsyslog_server
      tags: logging/rsyslog_server

- name: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ rsyslog-–∫–ª–∏–µ–Ω—Ç–æ–≤ (–æ—Ç–ø—Ä–∞–≤–∫–∞ –ª–æ–≥–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä)
  hosts: web:db-master:db-slave:ansible
  become: yes
  roles:
    - role: logging/rsyslog_client
      tags: logging/rsyslog_client

# üü¢ –°–Ω–∞—á–∞–ª–∞ –¥–∞–º–ø –ë–î
- name: –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ PostgreSQL (pg_dumpall + borg)
  hosts: db-master:db-slave
  become: true
  roles:
    - role: backup/pg_backup
      tags: backup/pg_backup

# üü¢ –ó–∞—Ç–µ–º –±—ç–∫–∞–ø borg –Ω–∞ –∫–ª–∏–µ–Ω—Ç–∞—Ö
- name: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ borgbackup –Ω–∞ –≤—Å–µ—Ö –∫–ª–∏–µ–Ω—Ç–∞—Ö (–∫—Ä–æ–º–µ ansible)
  hosts: web:db-master:db-slave
  become: yes
  roles:
    - role: backup/borg_client
      tags: backup/borg_client

# üü¢ –ò –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ ‚Äî borg init (–æ–¥–∏–Ω —Ä–∞–∑)
- name: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ borgbackup –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ (—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π)
  hosts: monitor
  become: yes
  roles:
    - role: backup/borg_server
      tags: backup/borg_server
      
- name: –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ PostgreSQL –∏–∑ –∞—Ä—Ö–∏–≤–∞ Borg
  hosts: db-master
  become: true
  roles:
    - role: backup/pg_restore
      tags: backup/pg_restore
      
- name: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ UFW
  hosts: all
  become: yes
  roles:
    - role: security/ufw
      tags: security/ufw

